name: Run Non Main CI Pipeline

on:
  push:
    branches:
      - REL_*
      - DEV_*
      - feature/*
    paths-ignore:
      - deploy-configs/**
      - README.md
      - .github/workflows/run-non-main-ci-pipeline.yaml

jobs:
  cicd:
    name: Run CI/CD
    uses: cvs-health-source-code/gha_workflow_actions/.github/workflows/gradle_docker.yaml@latest
    secrets: inherit
    with:
      JAVA_VERSION: 21.0.3
      JAVA_BUILD_COMMAND: ./gradlew build
      JAVA_LINT_COMMAND: echo "Lint"
      SCA_TOOL: snyk
      SAST_TOOL: snyk
      CONTAINER_SCAN_TOOL: snyk
      SNYK_ORG: cvs-health-default
      ALL_PROJECTS_SNYK: 'true'
      DOCKER_REGISTRY_NAME: cvsdigital-docker/specialty

  update-deployment-config:
    name: Update deployment config
    needs: cicd
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write
    steps:
      # if your action needs source files, check out first
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Update Deployment Config
        uses: cvs-health-source-code/update-deploy-configs/.github/actions/update-deployment-config@main
        with:
          type: harness
          build_type: gradle
          DEPLOY_FILE: scripts/deploy.yaml
          IMAGE_PR_REFRESH_TIMEOUT: 30
          IMAGE_PR_SLEEP_TIMEOUT: 20
          SKIP_SEMANTIC: 'false'
          APP_ID: ${{ secrets.GHA_WORKFLOW_APP_ID }}
          PRIVATE_KEY: ${{ secrets.GHA_WORKFLOW_APP_PRIVATE_KEY }}
          IMAGE_TAG_VERSION: ${{ needs.cicd.outputs.release_tag }}
          HOTFIX_RELEASE: 'false'
          HOTFIX_RELEASE_BRANCH: hotfix
